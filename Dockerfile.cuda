ARG BASE_IMAGE=ghcr.io/zbirenbaum/vllm:latest
FROM ${BASE_IMAGE} AS final

ARG COMMON_WORKDIR=/app

WORKDIR ${COMMON_WORKDIR}

# Step 1: Setup - Install system dependencies
RUN apt-get update && \
    apt-get install -y ffmpeg git && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

RUN mkdir -p ${COMMON_WORKDIR}/vllm-omni

# Step 2: Copy vllm-omni code and install
COPY . ${COMMON_WORKDIR}/vllm-omni
RUN cd ${COMMON_WORKDIR}/vllm-omni && SETUPTOOLS_SCM_PRETEND_VERSION=0.0.1 uv pip install --python "$(python3 -c 'import sys; print(sys.executable)')" --no-cache-dir "."

# Step 3: Overwrite base image's vllm_omni source with the new version
RUN cp -r ${COMMON_WORKDIR}/vllm-omni/vllm_omni/. ${COMMON_WORKDIR}/vllm_omni/

RUN ln -sf /usr/bin/python3 /usr/bin/python

# Entrypoint: clone latest vllm-omni source at startup, then exec the command
RUN printf '#!/bin/bash\nset -e\necho "[entrypoint] Syncing latest vllm-omni from GitHub..."\nTMPDIR=$(mktemp -d)\ngit clone --depth 1 https://github.com/zbirenbaum/vllm-omni.git "$TMPDIR"\ncp -r "$TMPDIR/vllm_omni/." /app/vllm_omni/\nrm -rf "$TMPDIR"\necho "[entrypoint] Sync complete. Running: $*"\nexec "$@"\n' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
